<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Assets & Expenses</title>
  <link rel="stylesheet" href="/static/style.css?v=200">
</head>
<body>

<div class="layout">

  <!-- Left sidebar -->
  <aside class="sidebar">
    <div class="sidebarCard">
      <div class="sidebarTitle">Navigation</div>

      <button id="navAssets" class="navBtn" type="button">Assets</button>
      <div id="assetsSubnav" class="subnav hidden">
        <button id="navAssetsCreate" class="navBtn subBtn" type="button">Create</button>
        <button id="navAssetsRetrieve" class="navBtn subBtn" type="button">Retrieve</button>
        <button id="navAssetsPending" class="navBtn subBtn" type="button">Pending</button>
      </div>

      <button id="navExpenses" class="navBtn" type="button">Expenses</button>
      <div id="expensesSubnav" class="subnav hidden">
        <button id="navExpensesCreate" class="navBtn subBtn" type="button">Create</button>
        <button id="navExpensesRetrieve" class="navBtn subBtn" type="button">Retrieve</button>
        <button id="navExpensesPending" class="navBtn subBtn" type="button">Pending</button>
      </div>
    </div>
  </aside>

  <div class="content">

    <!-- Blank landing -->
    <section id="blankSection" class="section">
      <div class="card">
        <div class="cardHeader">
          <div>
            <h1>Welcome</h1>
            <div class="subtitle">Select a module from the left navigation.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ASSETS SECTION -->
    <section id="assetsSection" class="section hidden">
      <div class="card">
        <div class="cardHeader">
          <div>
            <h1>Assets</h1>
            <div class="subtitle">Create, retrieve, and manage fixed assets</div>
          </div>
          <div class="badge">Assets</div>
        </div>

        <div class="hr"></div>

        <div id="assetPanelCreate" class="panel">
          <div class="panelTitle">Create Fixed Asset</div>

          <form id="assetForm">
          <div class="formGrid">
            <div class="field full">
              <label>Asset Name</label>
              <input id="asset_name" required>
            </div>

            <div class="field">
              <label>Asset Category</label>
              <select id="asset_category" required>
                <option value="COMPUTERS">Computers & Electronics</option>
                <option value="FURNITURE">Furniture & Equipment</option>
              </select>
            </div>

            <div class="field">
              <label>Purchase Cost</label>
              <input type="number" id="asset_cost" required>
            </div>

            <div class="field">
              <label>Purchase Date</label>
              <input type="date" id="purchase_date" required>
            </div>

            <div class="field">
              <label>Depreciation Start Date</label>
              <input type="date" id="depreciation_start_date" required>
            </div>

            <div class="field">
              <label>Useful Life (Months)</label>
              <input type="number" id="useful_life_months" required>
            </div>

            <div class="field full">
              <label>Salvage Value</label>
              <input type="number" id="salvage_value" value="0">
            </div>
          </div>

          <div class="actions">
            <button id="assetSubmitBtn" class="primary" type="submit">Create Asset</button>
          </div>
        </form>

        <div id="assetResult" class="result hidden"></div>
        
        <div id="assetPanelRetrieve" class="panel hidden">
          <div class="panelTitle">Retrieve Assets</div>

          <div class="row">
            <button id="assetRefreshBtn" type="button" class="secondary">Refresh</button>
          </div>

          <div id="assetListResult" class="result hidden"></div>

          <div id="assetTableWrap" class="tableWrap hidden">
            <table class="table">
              <thead>
                <tr>
                  <th>Asset</th>
                  <th>Status</th>
                  <th>Asset Number</th>
                  <th>Purchase Date</th>
                  <th>Cost</th>
                </tr>
              </thead>
              <tbody id="assetTableBody"></tbody>
            </table>
          </div>
        </div>

        <div id="assetPanelPending" class="panel hidden">
          <div class="panelTitle">Pending Assets</div>

          <div class="row">
            <button id="assetPendingRefreshBtn" type="button" class="secondary">Refresh</button>
          </div>

          <div id="assetPendingResult" class="result hidden"></div>

          <div id="assetPendingTableWrap" class="tableWrap hidden">
            <table class="table">
              <thead>
                <tr>
                  <th>Asset</th>
                  <th>Status</th>
                  <th>Asset Number</th>
                  <th>Purchase Date</th>
                  <th>Cost</th>
                </tr>
              </thead>
              <tbody id="assetPendingTableBody"></tbody>
            </table>
          </div>
        </div>
</div>
      </div>
    </section>

    <!-- EXPENSES SECTION -->
    <section id="expensesSection" class="section hidden">
      <div class="card">
        <div class="cardHeader">
          <div>
            <h1>Expenses</h1>
            <div class="subtitle">Create pending expenses and manage posted expenses</div>
          </div>
          <div class="badge">Expenses</div>
        </div>

        <div class="hr"></div>
        <!-- Create Pending Expense -->
        <div id="panelCreate" class="panel hidden">
          <div class="panelTitle">Create Pending Expense</div>

          <form id="pendingExpenseForm">
            <div class="formGrid">

              <div class="field">
                <label>Date</label>
                <input type="date" id="exp_date" required>
              </div>

              <div class="field">
                <label>Amount</label>
                <input type="number" step="0.01" id="exp_amount" required>
              </div>

              <div class="field">
                <label>Expense Account</label>
                <select id="exp_account_id" required>
                  <option value="">Loading…</option>
                </select>
                <div class="hint" id="exp_account_hint"></div>
              </div>

              <div class="field">
                <label>Paid Through</label>
                <select id="exp_paid_through_account_id" required>
                  <option value="">Loading…</option>
                </select>
                <div class="hint" id="paid_through_hint"></div>
              </div>

              <div class="field full">
                <label>Notes</label>
                <input id="exp_notes" placeholder="Optional">
              </div>

              <div class="field full">
                <label>Reference</label>
                <input id="exp_reference" placeholder="Optional">
              </div>

              <div class="field full">
                <label>Vendor (optional)</label>
                <select id="exp_vendor_id">
                  <option value="">No vendor</option>
                </select>
              </div>

              <div class="field full">
                <label>Attachment (optional)</label>
                <input type="file" id="exp_receipt" accept="image/*,application/pdf">
              </div>

            </div>

            <div class="actions">
              <button id="expenseSubmitBtn" class="primary" type="submit">Save as Pending</button>
            </div>
          </form>

          <div id="expenseResult" class="result hidden"></div>
        </div>

        <!-- Retrieve Zoho Expenses -->
        <div id="panelRetrieve" class="panel hidden">
          <div class="panelTitle">Retrieve Expenses (Zoho)</div>

          <div class="row">
            <input type="date" id="zoho_from" class="inlineInput" placeholder="From (optional)">
            <input type="date" id="zoho_to" class="inlineInput" placeholder="To (optional)">
            <input id="zoho_search" class="inlineInput" placeholder="Search text (optional)">
            <button id="expenseListBtn" type="button" class="secondary">Retrieve</button>
          </div>

          <div id="zohoResult" class="result hidden"></div>

          <div id="expenseTableWrap" class="tableWrap hidden">
            <table class="table" id="expenseTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Vendor</th>
                  <th>Reference</th>
                  <th>Receipt</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody id="expenseTableBody"></tbody>
            </table>
          </div>

          <pre id="expenseDetails" class="details hidden"></pre>
          <input type="file" id="zohoAttachFile" class="hidden" accept="image/*,application/pdf">
        </div>

        <!-- Pending Expenses -->
        <div id="panelPending" class="panel hidden">
          <div class="panelTitle">Pending Expenses</div>

          <div class="row">
            <input type="date" id="pending_from" class="inlineInput" placeholder="From (optional)">
            <input type="date" id="pending_to" class="inlineInput" placeholder="To (optional)">
            <button id="pendingListBtn" type="button" class="secondary">Load Pending</button>
          </div>

          <div id="pendingResult" class="result hidden"></div>

          <div id="pendingTableWrap" class="tableWrap hidden">
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Vendor</th>
                  <th>Reference</th>
                  <th>Receipt</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="pendingTableBody"></tbody>
            </table>
          </div>

          <pre id="pendingDetails" class="details hidden"></pre>
          <input type="file" id="pendingAttachFile" class="hidden" accept="image/*,application/pdf">
        </div>

      </div>
    </section>

  </div>
</div>

<script>
  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function formatDate(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function setCurrentMonthRange(fromEl, toEl) {
    const now = new Date();
    const first = new Date(now.getFullYear(), now.getMonth(), 1);
    const last = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    fromEl.value = formatDate(first);
    toEl.value = formatDate(last);
  }

  function setTodayIfEmpty(inputEl) {
    if (!inputEl.value) {
      inputEl.value = formatDate(new Date());
    }
  }

  function showResult(el, type, text) {
    el.classList.remove("hidden");
    el.classList.remove("success", "error");
    if (type) el.classList.add(type);
    el.textContent = text;
  }

  function fillSelect(selectEl, accounts, placeholder) {
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder || "Select…";
    selectEl.appendChild(opt0);

    accounts.forEach(a => {
      const opt = document.createElement("option");
      opt.value = a.account_id;
      const code = a.account_code ? `${a.account_code} — ` : "";
      const cur = a.currency ? ` (${a.currency})` : "";
      opt.textContent = `${code}${a.account_name}${cur}`;
      opt.dataset.code = a.account_code || "";
      opt.dataset.currency = a.currency || "";
      opt.dataset.type = a.account_type || "";
      selectEl.appendChild(opt);
    });
  }

  function updateHint(selectEl, hintEl) {
    const opt = selectEl.options[selectEl.selectedIndex];
    if (!opt || !opt.value) { hintEl.textContent = ""; return; }
    const code = opt.dataset.code ? `Code: ${opt.dataset.code}` : "";
    const type = opt.dataset.type ? `Type: ${opt.dataset.type}` : "";
    const cur = opt.dataset.currency ? `Currency: ${opt.dataset.currency}` : "";
    hintEl.textContent = [code, type, cur].filter(Boolean).join(" • ");
  }

  // Navigation (blank by default)
  const blankSection = document.getElementById("blankSection");
  const assetsSection = document.getElementById("assetsSection");
  const expensesSection = document.getElementById("expensesSection");

  const navAssets = document.getElementById("navAssets");
  const navExpenses = document.getElementById("navExpenses");

  const assetsSubnav = document.getElementById("assetsSubnav");
  const expensesSubnav = document.getElementById("expensesSubnav");

  const navAssetsCreate = document.getElementById("navAssetsCreate");
  const navAssetsRetrieve = document.getElementById("navAssetsRetrieve");
  const navAssetsPending = document.getElementById("navAssetsPending");

  const navExpensesCreate = document.getElementById("navExpensesCreate");
  const navExpensesRetrieve = document.getElementById("navExpensesRetrieve");
  const navExpensesPending = document.getElementById("navExpensesPending");

  function clearActive(btns) {
    btns.forEach(b => b.classList.remove("active"));
  }

  function showOnly(section) {
    [blankSection, assetsSection, expensesSection].forEach(s => s.classList.add("hidden"));
    section.classList.remove("hidden");
  }

  function setModule(module) {
    // Module buttons
    clearActive([navAssets, navExpenses]);
    if (module === "assets") navAssets.classList.add("active");
    if (module === "expenses") navExpenses.classList.add("active");

    // Subnav visibility
    assetsSubnav.classList.toggle("hidden", module !== "assets");
    expensesSubnav.classList.toggle("hidden", module !== "expenses");
  }

  function setSubActive(module, btn) {
    if (module === "assets") {
      clearActive([navAssetsCreate, navAssetsRetrieve, navAssetsPending]);
    } else if (module === "expenses") {
      clearActive([navExpensesCreate, navExpensesRetrieve, navExpensesPending]);
    }
    btn.classList.add("active");
  }

  async function initExpenses() {
    setTodayIfEmpty(document.getElementById("exp_date"));
    await Promise.all([loadCOADropdowns(), loadVendors()]);
  }

  // Start on landing
  showOnly(blankSection);

  // Module-level navigation
  navAssets.addEventListener("click", () => {
    setModule("assets");
    showOnly(assetsSection);
    setSubActive("assets", navAssetsCreate);
    showAssetPanel(assetPanelCreate);
  });

  navExpenses.addEventListener("click", async () => {
    setModule("expenses");
    showOnly(expensesSection);
    await initExpenses();
    setSubActive("expenses", navExpensesCreate);
    showPanel(panelCreate);
  });

  // Sub navigation (Assets)
  navAssetsCreate.addEventListener("click", () => {
    setModule("assets");
    showOnly(assetsSection);
    setSubActive("assets", navAssetsCreate);
    showAssetPanel(assetPanelCreate);
  });

  navAssetsRetrieve.addEventListener("click", async () => {
    setModule("assets");
    showOnly(assetsSection);
    setSubActive("assets", navAssetsRetrieve);
    showAssetPanel(assetPanelRetrieve);
    await loadAssets(false);
  });

  navAssetsPending.addEventListener("click", async () => {
    setModule("assets");
    showOnly(assetsSection);
    setSubActive("assets", navAssetsPending);
    showAssetPanel(assetPanelPending);
    await loadAssets(true);
  });

  // Sub navigation (Expenses)
  navExpensesCreate.addEventListener("click", async () => {
    setModule("expenses");
    showOnly(expensesSection);
    await initExpenses();
    setSubActive("expenses", navExpensesCreate);
    showPanel(panelCreate);
  });

  navExpensesRetrieve.addEventListener("click", async () => {
    setModule("expenses");
    showOnly(expensesSection);
    setSubActive("expenses", navExpensesRetrieve);
    showPanel(panelRetrieve);

    // Force current month range every time user clicks "Retrieve" in the left pane.
    const fromEl = document.getElementById("zoho_from");
    const toEl = document.getElementById("zoho_to");
    const searchEl = document.getElementById("zoho_search");
    setCurrentMonthRange(fromEl, toEl);
    searchEl.value = "";

    await loadZohoExpenses(true);
  });

  navExpensesPending.addEventListener("click", async () => {
    setModule("expenses");
    showOnly(expensesSection);
    setSubActive("expenses", navExpensesPending);
    showPanel(panelPending);

    // Pending shows all pending by default
    document.getElementById("pending_from").value = "";
    document.getElementById("pending_to").value = "";

    await loadPending();
  });

  // Panels
  const panelCreate = document.getElementById("panelCreate");
  const panelRetrieve = document.getElementById("panelRetrieve");
  const panelPending = document.getElementById("panelPending");

  function showPanel(panel) {
    [panelCreate, panelRetrieve, panelPending].forEach(p => p.classList.add("hidden"));
    panel.classList.remove("hidden");
  }

  // Default: show nothing until module chosen, then default expense panel is Create
  showPanel(panelCreate);

  // Assets
  const assetForm = document.getElementById("assetForm");
  const assetResult = document.getElementById("assetResult");
  const assetBtn = document.getElementById("assetSubmitBtn");

  const assetPanelCreate = document.getElementById("assetPanelCreate");
  const assetPanelRetrieve = document.getElementById("assetPanelRetrieve");
  const assetPanelPending = document.getElementById("assetPanelPending");

  const assetRefreshBtn = document.getElementById("assetRefreshBtn");
  const assetPendingRefreshBtn = document.getElementById("assetPendingRefreshBtn");

  const assetListResult = document.getElementById("assetListResult");
  const assetTableWrap = document.getElementById("assetTableWrap");
  const assetTableBody = document.getElementById("assetTableBody");

  const assetPendingResult = document.getElementById("assetPendingResult");
  const assetPendingTableWrap = document.getElementById("assetPendingTableWrap");
  const assetPendingTableBody = document.getElementById("assetPendingTableBody");

  function showAssetPanel(panel) {
    [assetPanelCreate, assetPanelRetrieve, assetPanelPending].forEach(p => p.classList.add("hidden"));
    panel.classList.remove("hidden");
  }

  function renderAssetTable(list, tbody, wrap) {
    tbody.innerHTML = "";
    list.forEach((x) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(x.asset_name || "")}</td>
        <td>${escapeHtml(x.status || "")}</td>
        <td>${escapeHtml(x.asset_number || "")}</td>
        <td>${escapeHtml(x.purchase_date || x.date || "")}</td>
        <td>${escapeHtml(String(x.asset_cost ?? x.purchase_cost ?? x.cost ?? ""))}</td>
      `;
      tbody.appendChild(tr);
    });
    wrap.classList.remove("hidden");
  }

  async function loadAssets(pendingOnly) {
    const resultEl = pendingOnly ? assetPendingResult : assetListResult;
    const wrapEl = pendingOnly ? assetPendingTableWrap : assetTableWrap;
    const bodyEl = pendingOnly ? assetPendingTableBody : assetTableBody;

    resultEl.classList.add("hidden");
    wrapEl.classList.add("hidden");
    bodyEl.innerHTML = "";

    try {
      const res = await fetch("/assets/all");
      const out = await res.json();
      if (!out.ok) throw new Error("Failed to retrieve assets");

      let list = out.assets || [];
      if (pendingOnly) {
        list = list.filter(a => String(a.status || "").toLowerCase() !== "active");
      }

      if (!list.length) {
        showResult(resultEl, "", pendingOnly ? "No pending assets." : "No assets found.");
        return;
      }

      renderAssetTable(list, bodyEl, wrapEl);
    } catch (e) {
      showResult(resultEl, "error", pendingOnly ? "Failed to load pending assets." : "Failed to load assets.");
    }
  }

  assetRefreshBtn.addEventListener("click", async () => loadAssets(false));
  assetPendingRefreshBtn.addEventListener("click", async () => loadAssets(true));

  assetForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    assetBtn.disabled = true;
    assetBtn.textContent = "Creating…";
    assetResult.classList.add("hidden");

    const payload = {
      asset_name: asset_name.value,
      asset_category: asset_category.value,
      asset_cost: Number(asset_cost.value),
      purchase_date: purchase_date.value,
      depreciation_start_date: depreciation_start_date.value,
      useful_life_months: Number(useful_life_months.value),
      salvage_value: Number(salvage_value.value)
    };

    try {
      const res = await fetch("/assets/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data.ok) {
        showResult(assetResult, "success", `Asset created successfully (Asset No: ${data.asset_number})`);
        assetForm.reset();
      } else {
        throw new Error(JSON.stringify(data, null, 2));
      }
    } catch {
      showResult(assetResult, "error", "Failed to create asset.");
    }

    assetBtn.disabled = false;
    assetBtn.textContent = "Create Asset";
  });

  // Expenses: dropdown loaders (existing logic)
  const expAccount = document.getElementById("exp_account_id");
  const expAccountHint = document.getElementById("exp_account_hint");
  const paidThrough = document.getElementById("exp_paid_through_account_id");
  const paidThroughHint = document.getElementById("paid_through_hint");

  async function loadCOADropdowns() {
    // Expense accounts
    const r1 = await fetch("/coa/expense-accounts");
    const d1 = await r1.json();
    const items1 = d1.items || d1.accounts || [];
    fillSelect(expAccount, items1, "Select…");
    updateHint(expAccount, expAccountHint);

    // Paid through accounts
    const r2 = await fetch("/coa/paid-through-accounts");
    const d2 = await r2.json();
    const items2 = d2.items || d2.accounts || [];
    fillSelect(paidThrough, items2, "Select…");
    updateHint(paidThrough, paidThroughHint);
  }

  expAccount.addEventListener("change", () => updateHint(expAccount, expAccountHint));
  paidThrough.addEventListener("change", () => updateHint(paidThrough, paidThroughHint));

  async function loadVendors() {
    const sel = document.getElementById("exp_vendor_id");
    sel.innerHTML = `<option value="">No vendor</option>`;
    try {
      const res = await fetch("/vendors/list?page=1&per_page=200");
      const out = await res.json();
      const list = out.vendors || out.items || [];
      list.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.vendor_id || v.id || "";
        opt.textContent = v.vendor_name || v.name || opt.value;
        sel.appendChild(opt);
      });
    } catch {
      // keep default
    }
  }

  // Create Pending Expense submit (existing style, same UI)
  const pendingExpenseForm = document.getElementById("pendingExpenseForm");
  const expenseBtn = document.getElementById("expenseSubmitBtn");
  const expenseResult = document.getElementById("expenseResult");

  pendingExpenseForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    expenseBtn.disabled = true;
    expenseBtn.textContent = "Saving…";
    expenseResult.classList.add("hidden");

    const payload = {
      date: document.getElementById("exp_date").value,
      amount: Number(document.getElementById("exp_amount").value),
      expense_account_id: document.getElementById("exp_account_id").value,
      paid_through_account_id: document.getElementById("exp_paid_through_account_id").value,
      notes: document.getElementById("exp_notes").value || "",
      reference: document.getElementById("exp_reference").value || "",
      vendor_id: document.getElementById("exp_vendor_id").value || ""
    };

    try {
      const res = await fetch("/pending-expenses/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const out = await res.json();
      if (!res.ok || !out.ok) throw new Error(JSON.stringify(out, null, 2));

      const pendingId = out.id || out.pending_id || out.pending_expense_id || out.pending?.id;

      // Optional receipt upload
      const f = document.getElementById("exp_receipt").files?.[0];
      if (f && pendingId) {
        const fd = new FormData();
        fd.append("file", f);
        const r2 = await fetch(`/pending-expenses/${encodeURIComponent(pendingId)}/attachments`, { method: "POST", body: fd });
        const o2 = await r2.json();
        if (!r2.ok || !o2.ok) throw new Error(JSON.stringify(o2, null, 2));
      }

      showResult(expenseResult, "success", `Saved to Pending (ID: ${pendingId}).`);
      pendingExpenseForm.reset();
      setTodayIfEmpty(document.getElementById("exp_date"));
      await Promise.all([loadCOADropdowns(), loadVendors()]);
    } catch (err) {
      showResult(expenseResult, "error", "Failed:\n" + (err?.message || String(err)));
    }

    expenseBtn.disabled = false;
    expenseBtn.textContent = "Save as Pending";
  });

  // Retrieve Zoho Expenses
  const expenseListBtn = document.getElementById("expenseListBtn");
  const expenseTableWrap = document.getElementById("expenseTableWrap");
  const expenseTableBody = document.getElementById("expenseTableBody");
  const expenseDetails = document.getElementById("expenseDetails");
  const zohoAttachFile = document.getElementById("zohoAttachFile");
  const zohoResult = document.getElementById("zohoResult");

  async function openLatestZohoAttachment(expenseId) {
    window.open(`/expenses/${encodeURIComponent(expenseId)}/attachments/open-latest`, "_blank");
  }

  async function attachToZohoExpense(expenseId) {
    zohoAttachFile.value = "";
    zohoAttachFile.onchange = async () => {
      const file = zohoAttachFile.files?.[0];
      if (!file) return;
      const fd = new FormData();
      fd.append("file", file);
      const res = await fetch(`/expenses/${encodeURIComponent(expenseId)}/attachments`, { method: "POST", body: fd });
      const out = await res.json();
      if (!res.ok || !out.ok) throw new Error(JSON.stringify(out, null, 2));
      showResult(zohoResult, "success", "Attachment added (non-overwriting).");
    };
    zohoAttachFile.click();
  }

  // forceCurrentMonth:
  // - if true: always overwrite the date inputs to current month
  // - if false: if both empty, default them to current month
  async function loadZohoExpenses(forceCurrentMonth) {
    zohoResult.classList.add("hidden");
    expenseDetails.classList.add("hidden");
    expenseTableWrap.classList.add("hidden");
    expenseTableBody.innerHTML = "";

    const fromEl = document.getElementById("zoho_from");
    const toEl = document.getElementById("zoho_to");
    const stEl = document.getElementById("zoho_search");

    if (forceCurrentMonth) {
      setCurrentMonthRange(fromEl, toEl);
    } else {
      const df0 = fromEl.value;
      const dt0 = toEl.value;
      if (!df0 && !dt0) {
        setCurrentMonthRange(fromEl, toEl);
      }
    }

    const df = fromEl.value;
    const dt = toEl.value;
    const st = (stEl.value || "").trim();

    // Pagination so you really get "everything"
    const PER_PAGE = 200;
    const MAX_PAGES = 50;

    const all = [];
    try {
      for (let page = 1; page <= MAX_PAGES; page++) {
        const params = new URLSearchParams();
        params.set("page", String(page));
        params.set("per_page", String(PER_PAGE));
        params.set("filter_by", "Status.All");

        if (df) params.set("date_from", df);
        if (dt) params.set("date_to", dt);
        if (st) params.set("search_text", st);

        const res = await fetch("/expenses/list?" + params.toString());
        const out = await res.json();
        if (!out.ok) throw new Error("Zoho error");

        const list = out.expenses || [];
        all.push(...list);

        if (list.length < PER_PAGE) break; // no more pages
      }

      if (!all.length) {
        showResult(zohoResult, "", "No expenses found.");
        return;
      }

      all.forEach((x) => {
        const tr = document.createElement("tr");
        const id = x.expense_id || "";

        tr.innerHTML = `
          <td>${escapeHtml(x.date || "")}</td>
          <td>${escapeHtml(String((x.total || x.amount || "") + (x.currency_code ? (" " + x.currency_code) : "")))}</td>
          <td>${escapeHtml(x.vendor_name || "")}</td>
          <td>${escapeHtml(x.reference || "")}</td>
          <td class="btnCell">
            <button class="btnSmall secondary" data-action="attach" data-id="${escapeHtml(id)}">Attach</button>
            <button class="btnSmall" data-action="open" data-id="${escapeHtml(id)}">Open</button>
          </td>
          <td class="btnCell">
            <button class="btnSmall" data-action="view" data-id="${escapeHtml(id)}">View/Edit</button>
          </td>
        `;

        tr.querySelectorAll("button").forEach(btn => {
          const action = btn.getAttribute("data-action");
          const eid = btn.getAttribute("data-id");
          btn.addEventListener("click", async () => {
            try {
              if (action === "open") return openLatestZohoAttachment(eid);
              if (action === "attach") return attachToZohoExpense(eid);
              if (action === "view") return viewZohoExpense(eid);
            } catch (err) {
              showResult(zohoResult, "error", "Failed:\n" + (err?.message || String(err)));
            }
          });
        });

        expenseTableBody.appendChild(tr);
      });

      expenseTableWrap.classList.remove("hidden");
      showResult(zohoResult, "success", `Loaded ${all.length} expenses.`);
    } catch {
      showResult(zohoResult, "error", "Failed to load expenses.");
    }
  }

  // When user clicks the button inside the panel:
  // If no dates are set, default to current month (but do not overwrite if user already chose dates)
  expenseListBtn.addEventListener("click", () => loadZohoExpenses(false));

  async function viewZohoExpense(expenseId) {
    expenseDetails.classList.add("hidden");
    const res = await fetch("/expenses/by-id/" + encodeURIComponent(expenseId));
    const data = await res.json();
    expenseDetails.textContent = JSON.stringify(data, null, 2);
    expenseDetails.classList.remove("hidden");
  }

  // Pending list
  const pendingListBtn = document.getElementById("pendingListBtn");
  const pendingTableWrap = document.getElementById("pendingTableWrap");
  const pendingTableBody = document.getElementById("pendingTableBody");
  const pendingDetails = document.getElementById("pendingDetails");
  const pendingResult = document.getElementById("pendingResult");
  const pendingAttachFile = document.getElementById("pendingAttachFile");

  async function openPendingAttachment(attId) {
    window.open(`/pending-expenses/attachments/open/${encodeURIComponent(attId)}`, "_blank");
  }

  async function attachToPending(pendingId) {
    pendingAttachFile.value = "";
    pendingAttachFile.onchange = async () => {
      const file = pendingAttachFile.files?.[0];
      if (!file) return;
      const fd = new FormData();
      fd.append("file", file);
      const res = await fetch(`/pending-expenses/${encodeURIComponent(pendingId)}/attachments`, { method: "POST", body: fd });
      const out = await res.json();
      if (!res.ok || !out.ok) throw new Error(JSON.stringify(out, null, 2));
      showResult(pendingResult, "success", "Attachment added to pending.");
      await loadPending();
    };
    pendingAttachFile.click();
  }

  async function approvePending(pendingId) {
    const res = await fetch(`/pending-expenses/${encodeURIComponent(pendingId)}/approve`, { method: "POST" });
    const out = await res.json();
    if (!res.ok || !out.ok) throw new Error(JSON.stringify(out, null, 2));
    showResult(pendingResult, "success", `Approved and posted to Zoho (Expense ID: ${out.zoho_expense_id}).`);
    await loadPending();
  }

  async function viewPending(pendingId) {
    pendingDetails.classList.add("hidden");
    const res = await fetch("/pending-expenses/" + encodeURIComponent(pendingId));
    const data = await res.json();
    pendingDetails.textContent = JSON.stringify(data, null, 2);
    pendingDetails.classList.remove("hidden");
  }

  async function loadPending() {
    pendingResult.classList.add("hidden");
    pendingDetails.classList.add("hidden");
    pendingTableWrap.classList.add("hidden");
    pendingTableBody.innerHTML = "";

    const df = document.getElementById("pending_from").value;
    const dt = document.getElementById("pending_to").value;

    const params = new URLSearchParams();
    if (df) params.set("date_from", df);
    if (dt) params.set("date_to", dt);

    const res = await fetch("/pending-expenses/list?" + params.toString());
    const out = await res.json();
    if (!out.ok) {
      showResult(pendingResult, "error", "Failed to load pending.");
      return;
    }

    const list = out.pending || [];
    if (!list.length) {
      showResult(pendingResult, "", "No pending expenses.");
      return;
    }

    list.forEach((x) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(x.date || "")}</td>
        <td>${escapeHtml(String(x.amount || ""))}</td>
        <td>${escapeHtml(x.vendor_name || "")}</td>
        <td>${escapeHtml(x.reference || "")}</td>
        <td class="btnCell">
          <button class="btnSmall secondary" data-action="attach" data-id="${escapeHtml(x.id)}">Attach</button>
        </td>
        <td class="btnCell">
          <button class="btnSmall" data-action="view" data-id="${escapeHtml(x.id)}">View/Edit</button>
          <button class="btnSmall secondary" data-action="approve" data-id="${escapeHtml(x.id)}">Approve</button>
        </td>
      `;

      tr.querySelectorAll("button").forEach(btn => {
        const action = btn.getAttribute("data-action");
        const pid = btn.getAttribute("data-id");
        btn.addEventListener("click", async () => {
          try {
            if (action === "attach") return attachToPending(pid);
            if (action === "approve") return approvePending(pid);
            if (action === "view") return viewPending(pid);
          } catch (err) {
            showResult(pendingResult, "error", "Failed:\n" + (err?.message || String(err)));
          }
        });
      });

      pendingTableBody.appendChild(tr);
    });

    pendingTableWrap.classList.remove("hidden");
  }

  pendingListBtn.addEventListener("click", loadPending);

  // Defaults
  setTodayIfEmpty(document.getElementById("purchase_date"));
  setTodayIfEmpty(document.getElementById("depreciation_start_date"));
</script>

</body>
</html>
<!-- CONFIRM GITHUB UPDATE -->
